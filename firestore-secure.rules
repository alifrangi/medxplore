rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Admin check
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.email != null &&
             (request.auth.token.email.matches('.*@medxplore\\.com'));
    }
    
    // Rate limiting helper (basic)
    function isRateLimited() {
      // Implement basic rate limiting logic here if needed
      return false;
    }
    
    // Students collection
    match /students/{passportNumber} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Applications collection
    match /applications/{applicationId} {
      allow create: if !isRateLimited(); // Basic rate limiting
      allow read, update, delete: if isAdmin();
    }
    
    // Events collection
    match /events/{eventId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Participations collection
    match /participations/{participationId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Admins collection
    match /admins/{adminId} {
      allow read: if true;
      allow write: if false;
    }
    
    // News collection
    match /news/{newsId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Workers collection - SECURED
    match /workers/{workerId} {
      // Allow read only for specific fields (no sensitive data)
      allow read: if true;
      
      // Allow session updates only
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['sessionToken', 'tokenExpiry', 'lastLogin']);
      
      allow create, delete: if isAdmin();
    }
    
    // Department collections
    match /departments/{departmentId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
      
      // Department messages - SECURED
      match /messages/{messageId} {
        allow read: if true;
        // Require basic validation for message creation (matching your current field names)
        allow create: if request.resource.data.keys().hasAll(['text', 'userId', 'userName']) &&
                     request.resource.data.text is string &&
                     request.resource.data.text.size() <= 1000 && // Max 1000 chars
                     request.resource.data.userId is string &&
                     request.resource.data.userName is string;
        allow update, delete: if isAdmin();
      }
      
      // Department ideas - SECURED  
      match /ideas/{ideaId} {
        allow read: if true;
        // Require basic validation for idea creation (matching your current field names)
        allow create: if request.resource.data.keys().hasAll(['title', 'description', 'userId', 'userName']) &&
                     request.resource.data.title is string &&
                     request.resource.data.description is string &&
                     request.resource.data.title.size() <= 100 &&
                     request.resource.data.description.size() <= 2000 && // Allow longer descriptions
                     request.resource.data.userId is string &&
                     request.resource.data.userName is string;
        allow update, delete: if isAdmin();
      }
      
      // Department files - SECURED
      match /files/{fileId} {
        allow read: if true;
        // Validate file metadata on creation (matching your current field names)
        allow create: if request.resource.data.keys().hasAll(['name', 'size', 'type', 'uploadedById', 'uploadedBy']) &&
                     request.resource.data.name is string &&
                     request.resource.data.size is number &&
                     request.resource.data.size <= 100 * 1024 * 1024 && // 100MB limit
                     request.resource.data.size > 0 && // Must have content
                     request.resource.data.type is string &&
                     request.resource.data.uploadedById is string &&
                     request.resource.data.uploadedBy is string;
        // Allow file deletion (app-level permission check)
        allow delete: if true;
        allow update: if isAdmin();
      }
    }
    
    // Other collections
    match /achievements/{achievementId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /tiers/{tierId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}